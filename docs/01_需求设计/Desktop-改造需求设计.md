# Oracle-X Desktop 改造需求设计

> 版本：v2.0 | 日期：2026-02-28 | 状态：待审批

---

## 背景

桌面端（Electron）当前存在两个阻碍用户体验的问题：

1. **依赖 MySQL**：用户安装后无法直接使用，必须先安装 MySQL、启动服务、创建数据库
2. **隐私权限无引导**：自动截图和 UI 元素监控需要 macOS「屏幕录制」和「辅助功能」权限，但缺少用户引导和同意机制

---

## 内部讨论记录

### 讨论主题：隐私权限策略

**产品经理**：自动截图是核心功能，但不能在没有用户同意的情况下静默截图。需要明确的权限引导和 opt-in 机制。用户应该清楚知道什么时候在截图、截图用在哪里。

**架构师**：macOS 从 Catalina 开始强制要求屏幕录制和辅助功能权限。`screencapture` 命令和 `osascript` 读取 UI 元素都需要对应权限。建议分两层：
- 基础功能（无权限）：手动截图分析、CSV 导入、市场数据
- 高级功能（需权限）：自动监控、按钮检测

**安全工程师**：必须做到：
1. 截图仅保存在本地临时目录，分析后立即删除
2. 截图数据不上传云端存储，仅发送给用户配置的 AI API 做一次性分析
3. 用户可以随时关闭自动监控
4. 设置页明确显示权限状态

**用户代言人**：首次启动不应弹出一堆权限请求，会吓跑用户。建议：软件先能用（基础功能），当用户主动开启"自动监控"时，再引导授权。

**最终决策**：
1. 默认关闭自动监控，首次启动只需基础功能
2. 用户手动开启"自动监控"时，触发权限引导流程
3. 权限引导包含：功能说明 + 隐私保护说明 + 一键跳转系统设置
4. 设置页显示权限状态（已授权/未授权）
5. 截图文件用后即删，不持久化

### 讨论主题：MySQL → SQLite

**架构师**：SQLite 是桌面应用的标准选择（VS Code、Obsidian、Slack 都用）。`better-sqlite3` 是同步 API，比 `mysql2` 的异步 API 更简单。数据文件自动存放在 `~/Library/Application Support/Oracle-X/`。

**DBA**：SQL 语法差异不大，主要注意：
- `AUTO_INCREMENT` → `AUTOINCREMENT`
- `?` 占位符保持不变
- 不需要连接池概念

**最终决策**：
- 用 `better-sqlite3` 替换 `mysql2`
- 数据库文件存放在 `app.getPath('userData')/oraclex.db`
- 应用启动时自动创建表（无需手动 DDL）
- 保持现有 API 接口不变，仅改底层实现

---

## 改造内容

### 改造 1：MySQL → SQLite

| 项目 | 当前 | 改造后 |
|------|------|--------|
| 依赖 | `mysql2` | `better-sqlite3` |
| 连接 | 需配置 host/port/user/password | 零配置，自动创建文件 |
| 数据位置 | MySQL 服务 | `~/Library/Application Support/Oracle-X/oraclex.db` |
| 启动要求 | 安装+启动 MySQL 服务 | 无 |
| SQL API | 异步 `db.execute()` → `[rows]` | 同步 `db.prepare().all()` |

**影响文件**：
- `database.js` — 完全重写
- `main.js` — 移除 MySQL 错误弹窗，简化初始化
- `package.json` — 依赖替换
- `.env.local` — 移除 MySQL 配置

### 改造 2：隐私权限引导

**权限分级**：

| 级别 | 功能 | 需要的权限 | 默认状态 |
|------|------|-----------|---------|
| 基础 | 手动截图分析、CSV 导入、钱包查询、市场数据 | 无 | ✅ 开启 |
| 高级 | 自动 App 监控 + 按钮检测 | 辅助功能 | ❌ 关闭 |
| 高级 | 自动截图分析 | 屏幕录制 | ❌ 关闭 |

**引导流程**：
1. 首次启动 → 欢迎页（不请求任何权限）
2. 用户在设置中开启"自动监控" → 弹出权限说明对话框
3. 对话框内容：功能说明 + 隐私承诺 + 「授权」/「取消」
4. 点击「授权」→ 跳转 macOS 系统设置对应页面
5. 设置页实时显示权限状态徽章

**隐私保护措施**：
- 截图文件分析后立即删除
- 不上传截图到任何云存储
- 自动监控可随时关闭
- 设置页显示"上次截图时间"透明化

---

## 代码变更清单

| # | 文件 | 类型 | 说明 |
|---|------|------|------|
| 1 | `desktop/database.js` | 重写 | MySQL → SQLite |
| 2 | `desktop/main.js` | 修改 | 简化初始化、权限引导集成 |
| 3 | `desktop/permission-manager.js` | 增强 | 分级权限检查 + 引导对话框 |
| 4 | `desktop/monitor.js` | 修改 | 启动前权限检查 |
| 5 | `desktop/package.json` | 修改 | mysql2 → better-sqlite3 |
| 6 | `desktop/.env.local` | 修改 | 移除 MySQL 配置 |
| 7 | `desktop/renderer/index.html` | 修改 | 设置页权限状态显示 |
| 8 | `desktop/renderer/renderer.js` | 修改 | 权限状态 UI 逻辑 |

---

## 验证计划

### 启动验证
1. `cd desktop && npm install && npm run dev`
2. 应用应正常启动，无 MySQL 错误
3. 数据库文件自动创建在 `~/Library/Application Support/Oracle-X/`

### 功能验证
1. CSV 导入 → 数据正确存储和读取
2. 设置保存 → 重启后保留
3. 手动截图（Cmd+Shift+S）→ 弹出分析结果
4. 自动监控开启 → 触发权限引导
5. 权限引导 → 正确跳转系统设置

### 用户体验验证
- 首次启动无权限弹窗
- 基础功能无需任何系统权限
- 权限引导文案清晰、不恐吓用户
