# Oracle-X Smart Intercept 需求设计文档

> 版本：v1.0 | 日期：2026-02-27 | 状态：待审批

---

## 1. 背景与目标

### 1.1 现状痛点

Oracle-X 当前三端存在**能力割裂**问题：

| 终端 | 已有能力 | 缺失 |
|------|----------|------|
| Chrome Extension | 8大交易平台按钮拦截 | 拦截后仅5秒冷静倒计时，**无AI分析** |
| Web App | AI流式分析 + 技术指标 + 情绪分析 | 仅3个硬编码交易对，需手动操作 |
| Desktop | 全局截图监控 + Vision AI | 分析结果不联动拦截决策 |

**核心问题：** Extension 能拦截但不分析，Web App 能分析但不拦截。

### 1.2 目标

将 Chrome Extension 的**按钮拦截能力**与 Web App 的 **AI 分析引擎**打通，实现：

> **用户在任意支持的交易平台点击买入/卖出时，自动触发 AI 风险分析，给出基于当前市场数据的风险建议。**

---

## 2. 用户故事

### US-1：交易拦截与分析
> 作为加密货币交易者，当我在 Binance 页面点击"买入 BTC"按钮时，Oracle-X 自动拦截操作，快速评估风险等级，并在侧边面板展示 AI 分析结果（技术指标 + 市场情绪 + 风险建议），让我在执行前做出更理性的决策。

### US-2：快速放行低风险交易
> 作为频繁交易者，当我进行的是低风险操作（如市场稳定时的小额交易），我不希望被过度打扰。系统应在 1 秒内显示一个小通知气泡后自动放行。

### US-3：高风险强制冷静
> 当市场剧烈波动或我的操作方向明显与技术指标矛盾时，系统应给出醒目的高风险警告，强制展示 AI 分析详情，让我充分了解风险后再决策。

### US-4：分析记录可追溯
> 每次拦截分析的结果（无论是否执行）都应记录到 Decision Log，方便我后续复盘。

---

## 3. 功能需求

### 3.1 两阶段分析架构

#### Stage 1：快速预判（本地，< 500ms）

在 Chrome Extension 内部完成，**不依赖网络请求**：

| 预判维度 | 数据来源 | 算法 |
|----------|----------|------|
| 价格波动率 | 页面提取 or 缓存的 ticker | 24h涨跌幅 > 10% 加分 |
| 连续交易检测 | Extension 本地存储 | 5分钟内同向操作 > 2次 加分 |
| RSI 极端值 | 缓存的 `/api/ticker` | RSI > 70 或 < 30 加分 |
| 杠杆倍数 | 页面提取 | > 10x 高风险加分 |

**评分规则：**

```
快速风险分 = 波动率分 + 频率分 + 指标分 + 杠杆分  (0-100)

≤ 30 分 → 🟢 低风险 → 小通知气泡（1秒自动消失）
31-60 分 → 🟡 中风险 → 侧边面板弹出 + 进入 Stage 2
> 60 分 → 🔴 高风险 → 侧边面板强制弹出 + 进入 Stage 2 + 冷静倒计时
```

#### Stage 2：AI 深度分析（远程，SSE 流式）

仅中/高风险时触发，调用现有 `/api/analyze` 接口：

```
Extension content.js 拦截按钮点击
       ↓ 提取交易上下文 (品种/价格/方向)
       ↓ Stage 1 本地评分 (< 500ms)
       ↓ 中/高风险 → 通知 background.js
       ↓ background.js 打开 Side Panel
       ↓ background.js 调用 /api/analyze
       ↓ SSE 流式返回 → 实时推送到 Side Panel
       ↓ 分析完成 → 展示结论 Badge (🟢/🟡/🔴)
       ↓ 用户选择：继续执行 / 取消 / 查看详情
```

### 3.2 交易上下文提取

Extension 拦截时需从页面提取：

| 信息 | 提取方式 | 必要性 |
|------|----------|--------|
| 交易对 (symbol) | CSS选择器 (`platform.symbolSelector`) | **必须** |
| 当前价格 | CSS选择器 (`platform.priceSelector`) | **必须** |
| 交易方向 (buy/sell) | 按钮匹配结果 | **必须** |
| 数量/金额 | 输入框读取 | 可选 |
| 杠杆倍数 | 页面提取 | 可选 |
| 订单类型 (限价/市价) | 页面提取 | 可选 |

> 已有 `platforms.js` 的 `getTradeInfo()` 可获取 symbol 和 price，需增强提取更多字段。

### 3.3 Symbol 标准化

不同平台的交易对格式不同，需统一为 Binance API 格式：

```
"BTC/USDT"   → "BTCUSDT"
"BTC-USDT"   → "BTCUSDT"
"BTC_USDT"   → "BTCUSDT"
"btcusdt"    → "BTCUSDT"
"XBTUSD"     → "BTCUSDT"   (Kraken 特殊映射)
```

### 3.4 分析缓存策略

| 场景 | 策略 |
|------|------|
| 同品种 5 分钟内再次操作 | 使用缓存的 Stage 2 结果，仅更新 Stage 1 评分 |
| 不同品种操作 | 完整执行 Stage 1 + Stage 2 |
| 用户手动刷新 | 强制重新分析 |
| 缓存过期 (5分钟) | 自动清除 |

### 3.5 降级与容错

| 异常场景 | 处理方式 |
|----------|----------|
| API 超时 (> 5秒) | 自动放行 + 标记"⚠️ 未完成分析" |
| API 不可用 | 仅展示 Stage 1 结果 + 提示"AI 服务离线" |
| 平台 DOM 变更导致提取失败 | 降级为仅冷静倒计时(现有行为) |
| 用户选择"继续执行" | 放行点击 + 记录决策日志 |
| 弹出窗口被用户关闭 | 直接放行 + 记录日志 |

### 3.6 多平台支持

现有 `platforms.js` 已定义 7 个平台 + 1 个 DEX：

| 平台 | 状态 | 备注 |
|------|------|------|
| Binance | ✅ 已有选择器 | 主要测试目标 |
| OKX | ✅ 已有选择器 | |
| Bybit | ✅ 已有选择器 | |
| Coinbase | ✅ 已有选择器 | |
| Kraken | ✅ 已有选择器 | symbol 映射特殊 |
| Gate.io | ✅ 已有选择器 | |
| Huobi | ✅ manifest 已配置 | 需补充 platforms.js |
| Uniswap | ✅ 已有选择器 | DEX，只有 Swap |

> 第一期聚焦加密货币市场。股票/期货等市场属于后续扩展方向。

---

## 4. 用户体验设计

### 4.1 渐进式干预

```
低风险 (≤30)              中风险 (31-60)           高风险 (>60)
┌──────────────┐    ┌──────────────────┐    ┌──────────────────┐
│ ✅ BTC/USDT  │    │ Side Panel 弹出  │    │ Side Panel 强制  │
│ 风险评估通过  │    │ ┌──────────────┐ │    │ + 冷静倒计时     │
│              │    │ │ 🟡 中等风险    │ │    │ ┌──────────────┐ │
│ (1秒后消失)  │    │ │ AI分析流式展示 │ │    │ │ 🔴 高风险!    │ │
└──────────────┘    │ │ [继续] [取消]  │ │    │ │ 请等待分析完成 │ │
                    │ └──────────────┘ │    │ │ 倒计时: 5s     │ │
                    └──────────────────┘    │ │ [继续] [取消]  │ │
                                           │ └──────────────┘ │
                                           └──────────────────┘
```

### 4.2 低风险通知气泡

注入到交易平台页面中，靠近用户点击位置：

- 紧凑型设计，不遮挡交易界面
- 1 秒后自动淡出
- 可点击展开详细分析
- 绿色主题色

### 4.3 中/高风险 Side Panel

复用现有 Side Panel (`sidepanel/`)，增强以下内容：

- **自动弹出**：无需用户手动点击扩展图标
- **交易上下文卡片**：展示平台名、交易对、价格、方向
- **Stage 1 快速评分仪表盘**：弧形进度条 + 分数
- **AI 流式分析区域**：复用现有渲染逻辑
- **结论 Badge**：🟢 / 🟡 / 🔴 + 风险说明
- **操作按钮**：继续执行 / 取消交易 / 修改参数

### 4.4 用户可配置项

在 Extension 设置页 (`settings/`) 中新增：

| 设置项 | 说明 | 默认值 |
|--------|------|--------|
| 智能拦截开关 | 总开关 | 开启 |
| 分析灵敏度 | 保守/标准/激进 | 标准 |
| 各平台独立开关 | 选择哪些平台启用拦截 | 全部开启 |
| 低风险通知方式 | 气泡/静默/关闭 | 气泡 |
| 缓存有效期 | 分析结果缓存时间 | 5分钟 |
| API 超时阈值 | 超时后自动放行 | 5秒 |

---

## 5. 数据流架构

```
┌─────────────────────────────────────────────────────────────────────┐
│                     Chrome Extension                                │
│                                                                     │
│  ┌─────────────────┐    ┌──────────────┐    ┌───────────────────┐  │
│  │  content.js      │    │ background.js│    │  sidepanel/       │  │
│  │  (Content Script)│    │ (Service     │    │  panel.js         │  │
│  │                  │    │  Worker)     │    │  (Side Panel)     │  │
│  │ 1.拦截按钮点击   │    │              │    │                   │  │
│  │ 2.提取交易上下文 │    │              │    │                   │  │
│  │ 3.Stage1 快速评分│    │              │    │                   │  │
│  │ 4.低风险→气泡    │───→│5.打开SidePanel│──→│6.展示分析进度     │  │
│  │   中/高→通知SW  │    │6.调用API     │    │7.流式展示AI结果   │  │
│  │                  │    │7.SSE流式转发 │───→│8.展示结论Badge    │  │
│  │ 9.收到放行信号   │←───│8.转发用户决策│←───│9.用户选择操作     │  │
│  │ 10.执行/取消     │    │              │    │                   │  │
│  └─────────────────┘    └──────┬───────┘    └───────────────────┘  │
│                                │                                    │
└────────────────────────────────┼────────────────────────────────────┘
                                 │
                                 ▼
                    ┌────────────────────────┐
                    │   Web App API Server   │
                    │   (Next.js on :3000)   │
                    │                        │
                    │  POST /api/analyze     │
                    │   ├─ Binance K线       │
                    │   ├─ 技术指标计算      │
                    │   ├─ Twitter情绪       │
                    │   └─ AI 流式分析       │
                    │                        │
                    │  GET /api/ticker       │
                    │   └─ 实时价格          │
                    │                        │
                    │  POST /api/decision    │
                    │   └─ NoFOMO评估        │
                    │                        │
                    │  POST /api/decision-log│
                    │   └─ 记录决策日志      │
                    └────────────────────────┘
```

---

## 6. 代码变更范围

### 6.1 Chrome Extension（主要改动）

| 文件 | 类型 | 变更说明 |
|------|------|----------|
| `content/content.js` | **重写** | 新增 Stage 1 快速评分、气泡通知、与 SW 通信 |
| `content/platforms.js` | **增强** | 增强 `getTradeInfo()` 提取更多字段、symbol 标准化 |
| `content/quick-scorer.js` | **新增** | Stage 1 快速风险评分引擎 |
| `content/bubble-notification.js` | **新增** | 低风险气泡通知组件 |
| `content/styles.css` | **增强** | 气泡通知样式 |
| `background.js` | **增强** | 新增拦截消息路由、自动打开 Side Panel |
| `sidepanel/panel.js` | **增强** | 支持自动接收拦截数据并开始分析 |
| `settings/settings.js` | **增强** | 新增智能拦截配置项 |
| `settings/settings.html` | **增强** | 新增配置表单 |
| `manifest.json` | **增强** | 可能需要追加权限 |

### 6.2 Web App API（小调整）

| 文件 | 类型 | 变更说明 |
|------|------|----------|
| `app/api/analyze/route.ts` | **微调** | 确保 symbol 兼容更多格式 |
| `lib/constants.ts` | **增强** | 新增 symbol 别名映射表 |

### 6.3 不涉及

- Desktop App：本期不改动
- Web App 前端页面：本期不改动

---

## 7. 假设清单

| # | 假设 | 影响 |
|---|------|------|
| A1 | 用户已在本地运行 Web App (localhost:3000) 或已部署到可访问的域名 | API 调用前提 |
| A2 | Binance API 可正常访问（或用户配置了代理） | K线数据获取 |
| A3 | 各交易平台的 DOM 选择器当前仍然有效 | 按钮拦截和信息提取 |
| A4 | 第一期仅支持加密货币市场 | 范围限定 |
| A5 | Chrome Extension 的 sidePanel API 支持通过代码打开 | 中/高风险时自动弹出 |

---

## 8. 讨论记录

### 内部讨论

**产品经理**：核心是"零摩擦干预"——低风险不打扰，高风险强拦截。分析速度必须快。

**架构师**：两阶段架构是最佳选择——Stage 1 本地 < 500ms 快速评分，Stage 2 远程 AI 仅在需要时触发。复用现有 `/api/analyze` 接口。

**测试工程师**：必须有降级策略。API 超时 5 秒自动放行。平台 DOM 变更时优雅降级。需防止重复拦截。

**用户代言人**：用侧边面板而非全屏弹窗展示分析结果。SSE 流式输出减少等待焦虑。所有操作记录到 Decision Log。

### 最终决策

1. 采用两阶段分析（Stage 1 本地 + Stage 2 远程）
2. 聚焦 Chrome Extension 端改造，复用现有 API
3. 渐进式干预（气泡→侧边→强制冷静）
4. 第一期仅加密货币市场
5. 5秒超时安全网 + 完善的降级策略

---

## 9. 非功能需求

| 维度 | 要求 |
|------|------|
| Stage 1 响应时间 | < 500ms |
| Stage 2 首字节时间 | < 2s |
| 缓存命中率 | 5分钟内同品种复用 |
| 降级可用性 | API 不可用时不阻断交易 |
| 兼容性 | Chrome 120+ / Edge 120+ |

---

## 10. 后续扩展方向（不在本期范围）

- 美股市场支持（Robinhood / Webull / 老虎证券）
- Desktop App 联动同步
- WebSocket 实时预警（行情突变主动通知）
- 交易复盘报告自动生成
- 移动端方案探索
