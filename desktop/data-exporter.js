/**
 * Oracle-X 数据导出器
 * 支持多种格式导出
 */

const fs = require('fs');

/**
 * 数据导出器
 */
class DataExporter {
  constructor() {
    this.formats = ['json', 'csv', 'markdown'];
  }

  /**
   * 导出交易记录
   */
  exportTransactions(transactions, format = 'json', filename = 'transactions') {
    let content = '';
    let mimeType = 'text/plain';
    let ext = format;

    switch (format) {
      case 'csv':
        content = this.toCSV(transactions);
        mimeType = 'text/csv';
        break;
      case 'markdown':
      case 'md':
        content = this.toMarkdown(transactions);
        mimeType = 'text/markdown';
        ext = 'md';
        break;
      default:
        content = JSON.stringify(transactions, null, 2);
        mimeType = 'application/json';
    }

    return {
      content,
      filename: `${filename}.${ext}`,
      mimeType,
    };
  }

  /**
   * 导出分析报告
   */
  exportAnalysis(analysis, format = 'markdown') {
    const stats = analysis.stats || {};
    const topSymbols = analysis.topSymbols || [];

    let content = '';
    
    if (format === 'markdown') {
      content = `# Oracle-X 交易分析报告

**生成时间**: ${new Date().toLocaleString()}

## 风险评估

- **风险等级**: ${analysis.riskLevel || '未知'}
- **风险分数**: ${analysis.score || 0}/100

## 交易统计

| 指标 | 数值 |
|------|------|
| 总交易次数 | ${stats.totalTrades || 0} |
| 买入次数 | ${stats.buyTrades || 0} |
| 卖出次数 | ${stats.sellTrades || 0} |
| 总交易额 | ${(stats.totalVolume || 0).toFixed(2)} USDT |
| 手续费 | ${(stats.totalFees || 0).toFixed(4)} USDT |
| 交易币种 | ${stats.uniqueSymbols || 0} |

## Top 交易币种

${topSymbols.map((t, i) => `${i+1}. **${t.symbol}** - ${t.trades} 笔 (${t.volume?.toFixed(2)} USDT)`).join('\n')}

## 洞察建议

${analysis.insights?.map(i => `- ${i.text}`).join('\n') || '无'}

---
*Generated by Oracle-X NoFOMO*
`;
    } else {
      content = JSON.stringify(analysis, null, 2);
    }

    return {
      content,
      filename: `oraclex-analysis-${Date.now()}.${format === 'markdown' ? 'md' : 'json'}`,
      mimeType: format === 'markdown' ? 'text/markdown' : 'application/json',
    };
  }

  /**
   * 转换为 CSV
   */
  toCSV(transactions) {
    if (!transactions?.length) return '';

    const headers = ['时间', '交易对', '方向', '价格', '数量', '总额', '手续费', '交易所'];
    const rows = transactions.map(tx => [
      tx.timestamp || '',
      tx.symbol || '',
      tx.side || '',
      tx.price || 0,
      tx.qty || 0,
      tx.total || 0,
      tx.fee || 0,
      tx.exchange || '',
    ]);

    return [
      headers.join(','),
      ...rows.map(row => row.join(','))
    ].join('\n');
  }

  /**
   * 转换为 Markdown
   */
  toMarkdown(transactions) {
    const rows = transactions.map(tx => 
      `| ${tx.timestamp?.slice(0,10) || '-'} | ${tx.symbol || '-'} | ${tx.isBuy ? '买入' : '卖出'} | ${tx.price?.toFixed(2) || '-'} | ${tx.total?.toFixed(2) || '-'} |`
    ).join('\n');

    return `# 交易记录

| 时间 | 交易对 | 方向 | 价格 | 总额 |
|------|--------|------|------|------|
${rows}
`;
  }

  /**
   * 保存到文件
   */
  async saveToFile(data, filepath) {
    await fs.promises.writeFile(filepath, data.content, 'utf-8');
    return filepath;
  }
}

module.exports = { DataExporter };
